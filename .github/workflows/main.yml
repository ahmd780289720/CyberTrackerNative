name: Build APK from ZIP

on:
  workflow_dispatch: {}
    push:
        paths:
              - "CyberTrackerNative.zip"

              jobs:
                build:
                    runs-on: ubuntu-latest

                        steps:
                              - name: Checkout
                                      uses: actions/checkout@v4

                                            - name: Unzip project
                                                    shell: bash
                                                            run: |
                                                                      set -e
                                                                                mkdir -p workspace
                                                                                          unzip -q CyberTrackerNative.zip -d workspace
                                                                                                    echo "== List workspace =="
                                                                                                              ls -la workspace
                                                                                                                        # جرّب المسار الشائع أولاً
                                                                                                                                  if [ -d "workspace/CyberTrackerNative" ]; then
                                                                                                                                              PROJECT_DIR="workspace/CyberTrackerNative"
                                                                                                                                                        else
                                                                                                                                                                    # ابحث تلقائياً عن مجلد فيه build.gradle.kts
                                                                                                                                                                                FOUND=$(find workspace -maxdepth 3 -type f -name "build.gradle.kts" -printf "%h\n" | head -n 1)
                                                                                                                                                                                            if [ -z "$FOUND" ]; then
                                                                                                                                                                                                          echo "❌ لم أجد build.gradle.kts داخل الـ ZIP"
                                                                                                                                                                                                                        exit 1
                                                                                                                                                                                                                                    fi
                                                                                                                                                                                                                                                PROJECT_DIR="$FOUND"
                                                                                                                                                                                                                                                          fi
                                                                                                                                                                                                                                                                    echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_ENV
                                                                                                                                                                                                                                                                              echo "== Project dir: $PROJECT_DIR =="
                                                                                                                                                                                                                                                                                        ls -la "$PROJECT_DIR"

                                                                                                                                                                                                                                                                                              - name: Set up JDK 17
                                                                                                                                                                                                                                                                                                      uses: actions/setup-java@v4
                                                                                                                                                                                                                                                                                                              with:
                                                                                                                                                                                                                                                                                                                        distribution: temurin
                                                                                                                                                                                                                                                                                                                                  java-version: "17"

                                                                                                                                                                                                                                                                                                                                        - name: Ensure Android SDK
                                                                                                                                                                                                                                                                                                                                                uses: android-actions/setup-android@v3
                                                                                                                                                                                                                                                                                                                                                        with:
                                                                                                                                                                                                                                                                                                                                                                  packages: |
                                                                                                                                                                                                                                                                                                                                                                              platform-tools
                                                                                                                                                                                                                                                                                                                                                                                          platforms;android-34
                                                                                                                                                                                                                                                                                                                                                                                                      build-tools;34.0.0

                                                                                                                                                                                                                                                                                                                                                                                                            - name: Cache Gradle
                                                                                                                                                                                                                                                                                                                                                                                                                    uses: actions/cache@v4
                                                                                                                                                                                                                                                                                                                                                                                                                            with:
                                                                                                                                                                                                                                                                                                                                                                                                                                      path: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                  ~/.gradle/caches
                                                                                                                                                                                                                                                                                                                                                                                                                                                              ~/.gradle/wrapper
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  restore-keys: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ${{ runner.os }}-gradle-

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    - name: Make gradlew executable (and fetch wrapper if missing)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            shell: bash
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              set -e
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        cd "$PROJECT_DIR"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if [ -f "gradlew" ]; then
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              chmod +x gradlew
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        fi
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  # حمّل ملف wrapper jar إن كان غير موجود (بعض المشاريع ما تضمّنه)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        echo "Downloading gradle-wrapper.jar ..."
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    mkdir -p gradle/wrapper
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                curl -sL -o gradle/wrapper/gradle-wrapper.jar \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              https://raw.githubusercontent.com/gradle/gradle/master/subprojects/wrapper/src/main/resources/gradle/wrapper/gradle-wrapper.jar
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        fi
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ls -la gradle/wrapper || true

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - name: Build Debug APK
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                working-directory: ${{ env.PROJECT_DIR }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        shell: bash
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                run: ./gradlew assembleDebug --no-daemon

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      - name: Upload APK
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              uses: actions/upload-artifact@v4
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                name: CyberTrackerNative-debug-apk
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          path: ${{ env.PROJECT_DIR }}/app/build/outputs/apk/debug/*.apk